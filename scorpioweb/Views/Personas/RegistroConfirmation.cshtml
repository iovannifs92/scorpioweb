@{
    ViewData["Title"] = "RegistroConfirmation";
}



@if (ViewBag.nombreRegistrado != null)
{

    <h2 class="alert alert-success" role="alert" style="text-align:center ">
        Registro exitoso de:<br />
        @ViewBag.nombreRegistrado<br />
        @ViewBag.idRegistrado<br />
       <a href="#" onclick="AlertCanalizacion('@ViewBag.idRegistrado','@ViewBag.NombreTabla')"><u>Canalizar algun servicio post penal</u></a>  
    </h2>

}
else
{
    <h2 style="text-align:center" class="alert alert-danger" role="alert">
        No se registro.<br>
        Comuniquese con su administrador.
    </h2>
}
<a asp-controller="@ViewBag.ControllerName" asp-action="Index" class="btn btn-link">
    Regresar al listado completo
</a>

<script> 
    //liat de estados
    var estados = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Estados));
    let delito = "";
    let causapenal = ""; 
    let tipo = "";
    let terapia = "";
    let periodo = "";
    let lugar = "";
    let curp = "";
    let vinculacion ="";
    let jornadas = "";
    let fechaCon = "";
    let nivelEstudios = "";
    let lnEstado = "";
    let fechaNacimiento = "";
    let fechaConclucion = "";

    function AlertCanalizacion(IdPersona, tabla) {
        // ALERTA 1: ¿Deseas iniciar?
        Swal.fire({
            title: "¿Deseas iniciar canalización de la persona?",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Si"
        }).then((result) => {
            if (result.isConfirmed) {
                // ALERTA 2: Formulario
                Swal.fire({
                    title: `@ViewBag.nombreRegistrado`,
                    html: `
                    <div style="text-align:left">
                      <hr/>
                      <p><strong>Area:</strong> ${tabla ?? ''}</p>
                      <p><strong>Teléfono:</strong> ${"@ViewBag.celular" ?? ''}</p>
                      <p><strong>Nombre Familiar:</strong> ${"@ViewBag.nombreF" ?? ''}</p>
                      <p><strong>Teléfono Familiar("@ViewBag.parentescoF"):</strong> ${"@ViewBag.celularF" ?? ''}</p>

                      <label><strong>Delito:</strong></label>
                      <input type="text" id="delito" class="swal2-input" placeholder="Delito"/>

                      <label><strong>Causa Penal:</strong></label>
                      <input type="text" id="causapenal" class="swal2-input" placeholder="Causa Penal"/>

                      <label><strong>Tipo de proceso:</strong></label><br>
                      <input type="radio" name="tipo" value="seleccionar" checked> Seleccionar <br>
                      <input type="radio" name="tipo" value="terapeutico"> Tratamiento terapéutico <br>
                      <input type="radio" name="tipo" value="vinculacion"> Servicio de vinculación <br>

                      <!-- Contenedor dinámico -->
                      <div id="opcionesExtra" style="margin-top:15px;"></div>
                    </div>
                    `,
                    imageUrl: "@ViewBag.Rutafoto",
                    imageHeight: 200,
                    imageAlt: "Foto de la persona",
                    showCancelButton: true,
                    confirmButtonText: 'Continuar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Recuperar valores SOLO después de confirmar
                        delito = document.getElementById("delito")?.value || "NA";
                        causapenal = document.getElementById("causapenal")?.value || "NA";
                        tipo = document.querySelector('input[name="tipo"]:checked')?.value || "NA";
                        // --- TERAPIA ---
                        terapia = document.getElementById("terapia")?.value || "NA";
                        if (terapia === "otro") {
                            terapia = document.getElementById("extraDatosT")?.value || "NA";
                        }
                        // --- VINCULACIÓN ---
                        let vinculacion = document.getElementById("vinculacion")?.value || "NA";
                        if (vinculacion === "otro") {
                            vinculacion = document.getElementById("extraDatosV")?.value || "NA";
                        }
                        periodo = document.getElementById("periodo")?.value || "NA";
                        lugar = document.getElementById("lugar")?.value || "NA";
                        curp = document.getElementById("curp")?.value || "NA";
                        jornadas = document.getElementById("jornadas")?.value || "NA";
                        fechaConclusion = document.getElementById("fechaConclucion")?.value || "NA";
                        nivelEstudios = document.getElementById("nivelEstudios")?.value || "NA";
                        lnEstado = document.getElementById("lnEstado")?.value || "NA";
                        fechaNacimiento = document.getElementById("fechaNacimiento")?.value || "NA";
                        //ALERTA 3: Confirmar datos
                        Swal.fire({
                            title: "¿Estas seguro que los datos son correctos?",
                            icon: "question",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Si"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $.ajax({
                                   type: "POST",
                                   dataType: "json",
                                   async: true,
                                   url: "/Reinsercion/CrearReinsercionPorSupervisor",
                                   traditional: true,
                                   data: {
                                    IdTabla: IdPersona,
                                    Tabla: tabla,
                                    Lugar: lugar,
                                    Estado: "EN ESPERA",
                                    Delito: delito,
                                    CausaPenal: causapenal,
                                    TipoServ: tipo,
                                    TipoTerapia: terapia,
                                    TipoVinculacion: vinculacion,
                                    PeriodoTerapia: periodo,
                                    CURP: curp,
                                    NumJornadas: jornadas,
                                    FechaConclusion: fechaConclusion,
                                    NivelEstudios: nivelEstudios,
                                    LugarNcimiento: lnEstado,
                                    FechaNacimiento: fechaNacimiento
                                    },
                                   success: function (response) {
                                       console.log('Respuesta del controlador:', response);
                                       sweetAlertAjax(true, response.responseText);

                                       // setTimeout(function () {
                                       //     window.location.href = response.viewUrl;
                                       // }, 1700);
                                   },
                                   error: function (xhr, status, error) {
                                       console.error('Error al enviar datos al controlador:', status, error);
                                       sweetAlertAjax(false, error);
                                   }
                                });
                                // AjaxCrearReinsercion(datos);
                            }
                        });
                    }
                });
            }
        });
    }

    // #<!-- #region Respuestas al onchange de algunos items -->
    document.addEventListener("change", function (e) {
        if (e.target.name === "tipo") {
            const tipo = e.target.value;
            const cont = document.getElementById("opcionesExtra");
            cont.innerHTML = "";
            if (tipo === "terapeutico") {
                cont.innerHTML = `
                  <label><strong>Tipo de terapia:</strong></label>
                  <select id="terapia" class="swal2-input">
                      <option value="">Seleccione...</option>
                      <option value="VIOLENCIA">Violencia</option>
                      <option value="ADICCIONES">Adicciones</option>
                      <option value="VIVIR SIN GOLPES">Vivir sin golpes</option>
                      <option value="otro">Otro</option>
                  </select>
                  <div id="otroTerapia"></div>
                  <label><strong>Periodo establecido:</strong></label>
                  <input type="text" id="periodo" class="swal2-input" placeholder="Periodo"/>
                  <label><strong>Lugar:</strong></label>
                  <input type="text" id="lugar" class="swal2-input" placeholder="Lugar"/>
                `;

                // Detectar "otro"
                cont.querySelector("#terapia").addEventListener("change", function () {
                    const otroDiv = document.getElementById("otroTerapia");
                    if (this.value === "otro") {
                        otroDiv.innerHTML = `<input type="text" value="" id="extraDatosT" class="swal2-input" placeholder="Especifique otro"/>`;
                    } else {
                        otroDiv.innerHTML = "";
                    }
                });
            }
            if (tipo === "vinculacion") {
                let opciones = `
                  <label><strong>Tipo de servicio:</strong></label>
                  <select id="vinculacion" class="swal2-input">
                      <option value="">Seleccione...</option>
                      <option value="laboral">Laboral</option>
                      <option value="educativa">Educativa</option>
                      <option value="antidoping">Antidoping</option>
                      <option value="jornadas">${"@ViewBag.ControllerName" === "Personas" ? "Servicio comunitario" : "Jornadas"}</option>
                      <option value="otro">Otro</option>
                  </select>
                  <div id="extraVinculacion"></div>
                `;
                cont.innerHTML = opciones;

                cont.querySelector("#vinculacion").addEventListener("change", function () {
                    const extra = document.getElementById("extraVinculacion");
                    extra.innerHTML = "";

                    if (this.value === "otro") {
                        extra.innerHTML = `<input type="text" value="" id="extraDatosV" class="swal2-input" placeholder="Especifique otro"/>`;
                    }
                    if (this.value === "jornadas") {
                        extra.innerHTML = `
                          <label><strong>CURP:</strong></label>
                          <input value="@ViewBag.CURP" type="text" id="curp" class="swal2-input" placeholder="CURP"/>
                          <p>Consulta tu curp aqui <a href="https://www.gob.mx/curp/" target="_blank">CURP</a>.</p>
                          <label class="col-md-12"><strong>${"@ViewBag.ControllerName" === "Personas" ? "Número de horas de servicio comunitario" : "Número de jornadas"}</strong></label>
                          <input type="number" id="jornadas" class="swal2-input" placeholder="${"@ViewBag.ControllerName" === "Personas" ? "Número de horas de servicio comunitario" : "Número de jornadas"}"/>
                          <label class="col-md-12"><strong>Fecha de Conclucion:</strong></label>
                          <input type="date" id="fechaConclucion" class="swal2-input" placeholder="Fecha de conclusión"/>
                        `;
                    }
                    if (this.value === "educativa") {
                        extra.innerHTML =   `<label><strong>Nivel de Estudios:</strong></label>
                                            <input type="text" id="nivelEstudios" class="swal2-input" placeholder="Nivel de estudios"/>`;
                    }
                    if (this.value === "antidoping") {
                        let opcionesestados = estados.map(e => `<option value="${e.Estado}">${e.Estado}</option>`).join("");
                        extra.innerHTML = `
                          <label><strong>Lugar de Registro:</strong></label>
                          <select class="swal2-input" name="lnEstado" id="lnEstado">
                            <option value="">-- Selecciona un estado --</option>
                            ${opcionesestados}
                          </select>
                          <label><strong>Fecha de Nacimiento:</strong></label>
                          <input type="date" id="fechaNacimiento" class="swal2-input" placeholder="Fecha de nacimiento"/>
                          <label><strong>CURP:</strong></label>
                          <input type="text" id="curp" class="swal2-input" value="@ViewBag.CURP" placeholder="CURP"/>
                          <p>Consulta tu curp aqui <a href="https://www.gob.mx/curp/" target="_blank">CURP</a>.</p>
                          <label><strong>Fecha de Conclusion:</strong></label>
                          <input type="date" id="fechaConclucion" class="swal2-input" placeholder="Fecha de conclusión"/>
                        `;
                    }
                });
            }
        }
    });


    // <!-- #endregion -->
    // function AjaxCrearReinsercion(datos) {
    //     alert(datos)
    //     alert(datos.TipoServ)
    //     alert(datos.PeriodoTerapia)
    //     alert(datos.CURP)
    //     alert(datos.NumJornadas)
    //     alert(datos.FechaConclusion)
    //     alert(datos.NivelEstudios)
    //     alert(datos.LugarNcimiento)
    //     alert(datos.FechaNacimiento)

    //    $.ajax({
    //        type: "POST",
    //        dataType: "json",
    //        async: true,
    //        url: "/Reinsercion/CrearReinsercionPorSupervisor",
    //        traditional: true,
    //        contentType: 'application/json; charset=utf-8',
    //        data: JSON.stringify(datos),
    //        success: function (response) {
    //            console.log('Respuesta del controlador:', response);
    //            sweetAlertAjax(true, response.responseText);

    //            setTimeout(function () {
    //                window.location.href = response.viewUrl;
    //            }, 1700);
    //        },
    //        error: function (xhr, status, error) {
    //            console.error('Error al enviar datos al controlador:', status, error);
    //            sweetAlertAjax(false, error);
    //        }
    //    });
    // }

    function sweetAlertAjax(isSuccess, respuestaAjax, callback) {
       if (isSuccess) {
           Swal.fire({
               icon: "success",
               title: "Persona en tramites de canalizacion, por favor espera la antencion!",
               text: respuestaAjax,
               showConfirmButton: false,
               timer: 1500
           });
       }
       else {
           Swal.fire({
               icon: "error",
               title: "la persona no ha sido canalizada!",
               text: "Comuniquese con el administrador del sistema, Error: " + respuestaAjax
           });
       }
    }
</script>