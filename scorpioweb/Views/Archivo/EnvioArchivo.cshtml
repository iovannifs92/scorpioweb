@*@model IEnumerable<scorpioweb.Models.Envioarchivo>*@
@model PaginatedList<scorpioweb.Models.Envioarchivo>


@{
    ViewData["Title"] = "EnvioArchivo";
}


<script type="text/javascript">

    function borrarEnvioA(id, recibido) {
        if (recibido == "1") {
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "No puedes borrar el registro porque ya lo recibió el área de archivo.",
                footer: '<a href="https://web.whatsapp.com/">Para mayor información consulte al área de sistemas</a>'
            });
        } else {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: "/Archivo/DeleteEnvioArchivo/",
                traditional: true,
                data: {
                    id: id,
                },
                success: function (response) {
                    if (response.borrar == true) {
                        Swal.fire({
                            title: "Borrrado Con Exito!",
                            icon: "success",
                            draggable: true,
                            timer: 1500
                        });
                        location.reload();
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: "No puedes borrar " + response.mensaje,
                            footer: '<a href="https://web.whatsapp.com/">Para mayor información consulte al área de sistemas</a>'
                        });
                    }
                },
                error: function (response) {

                    alert(response.error);

                }
            });
        }
    }


    //        //if (response.success == true) {
    //        //    Swal.fire({
    //        //        title: "Guardado",
    //        //        text: "Tu registro se ha guardado",
    //        //        icon: "success"
    //        //    }).then((result) => {
    //        //        if (result.isConfirmed) {
    //        //            retraso(response.viewUrl, 70);
    //        //        } else {
    //        //            retraso(response.viewUrl, 70);
    //        //        }
    //        //    });
    //        //} else {
    //        //    Swal.fire({
    //        //        title: "Error al Borrar",
    //        //        text: "Contacte con el administrador del sistema " + response.error,
    //        //        icon: "error"
    //        //    });

    function modal(id, recibido) {
        var url = "/Archivo/editEnvioArchivo/" + id;
        var title = "Editar Envio Archivo";

        if (recibido == "1") {
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "No puedes editar porque ya lo recibió el área de archivo.",
                footer: '<a href="https://web.whatsapp.com/">Para mayor información consulte al área de sistemas</a>'
            });
        } else {
            $.ajax({
                type: "GET",
                url: url,
                success: function (res) {
                    $("#form-modal .modal-body").html(res);
                    $("#form-modal .modal-title").html(title);
                    $("#form-modal").modal('show');
                    $("#form-modal").find(".modal-dialog").removeClass("modal-lg modal-sm").addClass("modal-lg");
                },
                error: function (res) {
                    console.log("Error al cargar el modal");
                }
            });
        }
    }

    function recibido(id) {
        document.getElementById("myCheckbox " + id).disabled = true;
        QuienRecibe = "@User.Identity.Name"
        $.ajax({
            type: "POST",
            url: "/archivo/recibido",
            traditional: true,
            data: {
                id, QuienRecibe,
            },
            error: function (response) {
                alert("Hubo un error, no se pudieron guardar los datos, contacte con el administrador del sistema");
                Console.Message(response);
            }
        });
    }

    function revisado(id) {
        QuienRevisa = "@User.Identity.Name"
        $.ajax({
            type: "POST",
            url: "/Archivo/revisado",
            traditional: true,
            data: {
                id, QuienRevisa,
            },
            error: function (response) {
                alert("Hubo un error, no se pudieron guardar los datos, contacte con el administrador del sistema");
                Console.Message(response);
            }
        });
    }
    function actualizarIdArchivo(id) {
        var idarchivo = document.getElementById("idarchivo_" + id).value;
        $.ajax({
            type: "POST",
            url: "/Archivo/ActualizarIdArchivo",
            data: {
                id: id,
                idarchivo: idarchivo
            },
            success: function () {
                console.log("Idarchivo actualizado");
            },
            error: function () {
                alert("Error al actualizar idarchivo");
            }
        });
    }
    function actualizarObservaciones(id) {
        var observaciones = document.getElementById("observaciones_" + id).value;
        $.ajax({
            type: "POST",
            url: "/Archivo/ActualizarObservaciones",
            data: {
                id: id,
                observaciones: observaciones
            },
            success: function () {
                console.log("Observaciones actualizadas");
            },
            error: function () {
                alert("Error al actualizar observaciones");
            }
        });
    }


    function createEnvioArchivo() {
        //PRIMERO SOLICITAMOS LOS DATOS  PARA BUSCAR A LA PERSONA ADULTA
        Swal.fire({
            title: "Buscar persona",
            html: `
                <div>
                    <label class="control-label">Area: @ViewBag.AreaAsignada</label>
                    <br/>
                    <label class="control-label">Coloque el Id</label>
                    <input required id="Id" type="text" class="form-control"/>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: "Buscar",
            cancelButtonText: "Cancelar",
            cancelButtonColor: "#d33",
            focusConfirm: false,
            preConfirm: () => {
                //AQUI SE ACCEDE ANTES DE CONTINUAR CON LA FUNCION AJAX
                const tabla = "@ViewBag.AreaAsignada";
                const id = document.getElementById('Id').value;
               
                //SI NO ESTAN COMPLETOS SE RETORNA LA FUNCION SOLICITANDO QUE LOS LLENEN
                if (!id || !tabla) {
                    Swal.showValidationMessage('Llena los campos para continuar!');
                    return false;
                }
                //ANIMACION DE BUSCANDO
                Swal.showValidationMessage(`
                    <div style="display:flex;align-items:center;gap:8px;justify-content:center;">
                        <div class="swal2-loader"></div> Buscando...
                    </div>
                `);
                //SI TODO ES CORRECTO Y NO FALTA NINGUN DATO LLEGA AQUI PARA BUSCAR Y SE VA AL CONTROLADOR
                return $.ajax({
                    url: '/Api/Sacardatos',
                    type: 'GET',
                    data: { id: id, tabla: tabla },
                    success: function(response) {
                        //SI HAY UN ERROR EN EL CONTROLADOR
                        // alert(response.lista[0].p.nombre)
                        // alert(response.lista[0].p.paterno)
                        // alert(response.lista[0].p.materno)
                        if (response.error) {
                            Swal.fire('Error', response.message, 'error');
                            return;
                        }
                        //SI TODO ESTA BIEN SE CIERRA ESTE MODAL
                        Swal.close();
                        //LOS DATOS DE LA RESPUESTA SE VAN AL SIGUIENTE METODO PARA CREAR EL CARNET
                        alert(1)
                        ConfirmacionEnvioArchivo(response.lista[0]);
                    },
                    error: function(message) {
                        Swal.showValidationMessage(`Request failed: ${message.statusText}`);
                    }
                });
            }
        });
    }


    function ConfirmacionEnvioArchivo(data) {
        Swal.fire({
            title: 'Datos de persona encontrados',
            html: `
                <img src="${data.p.rutaFoto}" style="width:150px;height:150px;border-radius:8px;margin-bottom:10px;" />
                <p>ID Persona: ${data.p.idPersona}</p>
                <p>Nombre: ${data.p.nombre} ${data.p.paterno} ${data.p.materno}</p>
                `,
            showCancelButton: true,
            confirmButtonText: 'Siguente',
            confirmButtonColor: '#02bd05',
            cancelButtonText: 'Cancelar',
            cancelButtonColor: "#d33",
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Envioarchivo/BuscarSupervision',
                    type: 'POST',
                    data:  { id,tabla },                // send FormData directly
                    contentType: false,            //son necesarios para manda la informacion correctamente // let browser set multipart/form-data
                    processData: false,            // do not stringify FormData
                    success: function(response) {
                        if (!response.success) {
                            Swal.fire('Error', response.message || 'Ocurrió un error', 'error');
                        } else {
                            Swal.fire('Éxito', response.message, 'success').then(() => {
                                window.open(response.url, '_blank');
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire('Error', 'No se pudo crear el carnet: ' + error, 'error');
                    }
                });

                //SI LOS DATOS SON CONFIRMADOS POR EL USUARIO SE TRANSFORMAN LOS DATOS A LA FORMA CORRECTA PARA EL METODO
                //ESTO SE HACE POR QUE EN EL METODO CrearCarnet SE ESPERA UN MODELO DEL TIPO [FromForm]
                //const formData = new FormData();

                //NOTA LAS COSAS ENTRE COMILLAS DEBEN DE SER IGUAL QUE LOS NOMBRE DEL MODELO PersonaCarnetViewModel SI NO VAN A ESTAR VACIOS
                // formData.append("IdPersona", data.idPersona);
                // formData.append("Nombre", data.nombre);
                // formData.append("Telefono", data.telefono);

                //alert(data.p.idPersona)


       
            }
        });
    }

    
</script>


<h2>Envio Archivo</h2>
@*
<p>
    <a asp-action="Create"></a>
</p>
*@

<form asp-action="Envioarchivo" method="get" class="mb-4">
    <div class="row g-3 align-items-end">
        <!-- Búsqueda por nombre o Id -->
        <div class="col-md-2">
            <label for="SearchString" class="form-label">Nombre o IdArchivo</label>
            <input type="text" id="SearchString" name="SearchString" class="form-control" placeholder="Buscar..." value="@ViewData["currentFilter"]" />
        </div>

        <!-- Filtro Área -->
        <div class="col-md-2">
            <label>
                Area
            </label>
            <select class="form-control" name="areaFiltro" id="areaFiltro"
                    asp-items="@(new SelectList(ViewBag.ListaAreas, "Text", "Text", @ViewData["areaFiltro"]))">
            </select>
        </div>

        <!-- Filtro Recibido -->
        <div class="col-md-2">
            <label>
                Recibido
            </label>
            <select class="form-control" name="recibidoFiltro" id="recibidoFiltro"
                    asp-items="@(new SelectList(ViewBag.listaFiltro1, "Text", "Text", @ViewData["recibidoFiltro"]))">
            </select>
        </div>

        <!-- Filtro Revisado -->
        <div class="col-md-2">
            <label>
                Revisado
            </label>
            <select class="form-control" name="revisadoFiltro" id="revisadoFiltro"
                    asp-items="@(new SelectList(ViewBag.listaFiltro2, "Text", "Text", @ViewData["revisadoFiltro"]))">
            </select>
        </div>

        <!-- Filtro Fecha Desde -->
        <div class="col-md-2">
            <label for="fechaDesde" class="form-label">Fecha Desde</label>
            <input type="date" id="fechaDesde" name="fechaDesde" class="form-control" value="@ViewBag.fInicio" />
        </div>

        <!-- Filtro Fecha Hasta -->
        <div class="col-md-2">
            <label for="fechaHasta" class="form-label">Fecha Hasta</label>
            <input type="date" id="fechaHasta" name="fechaHasta" class="form-control" value="@ViewBag.fFinal" />
        </div>

        <!-- Botón Buscar -->
        <div class="col-md-2" style="margin-top:20px;">
            <button type="submit" class="btn btn-primary">
                <i class="fa fa-search me-1"></i> Buscar
            </button>
        </div>
    </div>
</form>
<hr size="2px" color="black" />
<div style="text-align:left" class="col-md-6">
    <a asp-action="Envioarchivo">Regresar al Listado Completo </a>
</div>
<div style="text-align:right" class="col-md-6">
    <a onclick="createEnvioArchivo();" class="button-27 carnet" id="createEnvioArchivo" title="Envio Archivo">
        <i class=" btn btn-primary fa fa-book float-right">&nbsp;Crear nuevo Registro</i>
    </a>
</div>

<table class="table">
    <thead>
        <tr>
                <th>
                    Fecha de Recibido
                </th>
                <th>
                    Area
                </th>
                <th>
                    Nombre completo
                </th>
                <th>
                    Causa Penal
                </th>
                <th>
                    Delito
                </th>
                <th>
                    Tipo de Documento
                </th>
                <th>
                    Situacion Juridico
                </th>
                @if (User.IsInRole("Coordinador"))
                {
                    <td>
                        Quien Recibe
                    </td> 
                    <td>
                        Fecha Recibido
                    </td>
                    <td>
                        Quien Revisa
                    </td>
                    <td>
                        Fecha Revisado
                    </td>
                }
                 @if (User.IsInRole("ArchivoAsistente") || User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                    <th>
                        Revisado
                    </th>
                    <th>
                        Id de Archvo
                    </th>
                    <th>
                        Observaciones
                    </th>
                }
                 @if (User.IsInRole("EnvioArchivo") || User.IsInRole("Masteradmin"))
                {
                    <th>
                        Editar
                    </th>
                }

           
            <th></th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.FechaRecibido)
            </td> 
            <td>
                @Html.DisplayFor(modelItem => item.Area)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Nombre) @Html.DisplayFor(modelItem => item.Apaterno) @Html.DisplayFor(modelItem => item.Amaterno)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Causapenal)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Delito)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.TipoDocumento)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.SituacionJuridico)
            </td>
            @if (User.IsInRole("Coordinador"))
            {
                <td>
                    @Html.DisplayFor(modelItem => item.QuienRecibe)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.FechaRecibido)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.QuienRevisa)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.FechaRevisado)
                </td>
            }
            <td>
                @if (User.IsInRole("ArchivoAsistente") || User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                if(item.Recibido == 0)
                {
                    <input class="form-check-input" type="checkbox" id="myCheckbox @item.IdenvioArchivo" onchange="recibido(@item.IdenvioArchivo)" @(item.Recibido == 1 ? "checked" : "") />
                }else{
                    <input class="form-check-input" type="checkbox" disabled id="myCheckbox @item.IdenvioArchivo " onchange="recibido(@item.IdenvioArchivo)" @(item.Recibido == 1 ? "checked" : "") />
                }
                }else{
                    <input disabled class="form-check-input" type="checkbox" id="myCheckbox @item.IdenvioArchivo" onchange="recibido(@item.IdenvioArchivo)" @(item.Recibido == 1 ? "checked" : "") />
                }
                  
            </td>
            <td>
                 @if (User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                        <input class="form-check-input" type="checkbox" onchange="revisado(@item.IdenvioArchivo)" @(item.Revisado == 1 ? "checked" : "") />
                }
                else if (User.IsInRole("ArchivoAsistente"))
                {
                    <input disabled class="form-check-input" type="checkbox" onchange="revisado(@item.IdenvioArchivo)" @(item.Revisado == 1 ? "checked " : "") />

                }else
                {
                    <input style="display:none" disabled class="form-check-input" type="checkbox" onchange="revisado(@item.IdenvioArchivo)" @(item.Revisado == 1 ? "checked " : "") />
                }
                    
            </td>
            <td>
                @if (User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                    <input type="text" class="form-control" id="idarchivo_@item.IdenvioArchivo" value="@item.IdArchvo" onblur="actualizarIdArchivo(@item.IdenvioArchivo)" style="width: 100px;" />

                }
                else if (User.IsInRole("ArchivoAsistente"))
                {
                    <input disabled type="text" class="form-control" id="idarchivo_@item.IdenvioArchivo" value="@item.IdArchvo" onblur="actualizarIdArchivo(@item.IdenvioArchivo)" />
                }else
                {
                    <input style="display:none" disabled type="text" class="form-control" id="idarchivo_@item.IdenvioArchivo" value="@item.IdArchvo" onblur="actualizarIdArchivo(@item.IdenvioArchivo)" />    
                }   
            </td>

            <td>
                @if (User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                    <input type="text" class="form-control" id="observaciones_@item.IdenvioArchivo" value="@item.Observaciones" style="min-width: 300px;" onblur="actualizarObservaciones(@item.IdenvioArchivo)" />
                }
                else if (User.IsInRole("ArchivoAsistente"))
                {
                    <input disabled type="text" class="form-control" id="observaciones_@item.IdenvioArchivo" value="@item.Observaciones" style="min-width: 300px;" onblur="actualizarObservaciones(@item.IdenvioArchivo)" />
                }else
                {
                    <input style="display:none" disabled type="text" class="form-control" id="observaciones_@item.IdenvioArchivo" value="@item.Observaciones" style="min-width: 300px;" onblur="actualizarObservaciones(@item.IdenvioArchivo)" />
                }
                    
            </td>
            @if (User.IsInRole("EnvioArchivo") || User.IsInRole("Masteradmin"))
            {
                <td>
                    <a id="btnEditar" onclick="modal(@item.IdenvioArchivo, @item.Recibido)" class="btn btn-success">
                        <i class="fa fa-pencil"></i> Editar
                    </a>

                    @*<a id="btnEditar" onclick="showModal('@Url.Action("editEnvioArchivo","Archivo",null,Context.Request.Scheme)','Editar Registro', @item.IdenvioArchivo)" class="btn btn-success">*@

                </td> 
                <td>
                    <a id="btnBorrar" onclick="borrarEnvioA(@item.IdenvioArchivo, @item.Recibido)" class="btn btn-danger">
                        <i class="fa fa-trash"></i> Borrar
                    </a>
                </td>
            }
        </tr>
    }
    </tbody>
</table>

@{
    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
}

<p>
    Página @(Model.TotalPages < Model.PageIndex ? 0 : Model.PageIndex) de @Model.TotalPages
</p>
<a asp-action="Envioarchivo"
   asp-route-sortOrder="@ViewData["CurrentSort"]"
   asp-route-pageNumber="@(Model.PageIndex - 1)"
   asp-route-currentFilter="@ViewData["CurrentFilter"]"
   asp-route-areaFiltro="@ViewData["areaFiltro"]"
   asp-route-recibidoFiltro="@ViewData["recibidoFiltro"]"
   asp-route-revisadoFiltro="@ViewData["revisadoFiltro"]"
   asp-route-fechaInicio="@ViewData["fInicio"]"
   asp-route-fechaFinal="@ViewData["fFinal"]"
   class="btn btn-default @prevDisabled">
    Anterior
</a>
<a asp-action="Envioarchivo"
   asp-route-sortOrder="@ViewData["CurrentSort"]"
   asp-route-pageNumber="@(Model.PageIndex + 1)"
   asp-route-currentFilter="@ViewData["CurrentFilter"]"
   asp-route-areaFiltro="@ViewData["areaFiltro"]"
   asp-route-recibidoFiltro="@ViewData["recibidoFiltro"]"
   asp-route-revisadoFiltro="@ViewData["revisadoFiltro"]"
   asp-route-fechaDesde="@ViewBag.fInicio"
   asp-route-fechaHasta="@ViewBag.fFinal"
   class="btn btn-default @nextDisabled">
    Siguiente
</a>