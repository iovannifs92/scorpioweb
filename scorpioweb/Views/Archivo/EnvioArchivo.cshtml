@*@model IEnumerable<scorpioweb.Models.Envioarchivo>*@
@model PaginatedList<scorpioweb.Models.Envioarchivo>


@{
    ViewData["Title"] = "EnvioArchivo";
}


<script type="text/javascript">
    var area = "";
    function borrarEnvioA(id, recibido) {
        if (recibido == "1") {
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "No puedes borrar el registro porque ya lo recibió el área de archivo.",
                footer: '<a href="https://web.whatsapp.com/">Para mayor información consulte al área de sistemas</a>'
            });
        } else {
            Swal.fire({
                title: "¿Estás seguro?",
                text: "Esta acción eliminará el registro de forma permanente.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sí, borrar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        url: "/Archivo/DeleteEnvioArchivo/",
                        traditional: true,
                        data: { id: id },
                        success: function (response) {
                            if (response.borrar == true) {
                                Swal.fire({
                                    title: "¡Borrado con éxito!",
                                    icon: "success",
                                    timer: 1500,
                                    showConfirmButton: false
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: "error",
                                    title: "Oops...",
                                    text: "No puedes borrar " + response.mensaje,
                                    footer: '<a href="https://web.whatsapp.com/">Para mayor información consulte al área de sistemas</a>'
                                });
                            }
                        },
                        error: function (response) {
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: "Ocurrió un problema al intentar borrar el registro."
                            });
                        }
                    });
                }
            });
        }
    }


    function modal(id, recibido) {
        var url = "/Archivo/editEnvioArchivo/" + id;
        var title = "Editar Envio Archivo";

        if (recibido == "1") {
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "No puedes editar porque ya lo recibió el área de archivo.",
                footer: '<a href="https://web.whatsapp.com/">Para mayor información consulte al área de sistemas</a>'
            });
        } else {
            $.ajax({
                type: "GET",
                url: url,
                success: function (res) {
                    $("#form-modal .modal-body").html(res);
                    $("#form-modal .modal-title").html(title);
                    $("#form-modal").modal('show');
                    $("#form-modal").find(".modal-dialog").removeClass("modal-lg modal-sm").addClass("modal-lg");
                },
                error: function (res) {
                    console.log("Error al cargar el modal");
                }
            });
        }
    }

    function recibido(id) {
        document.getElementById("myCheckbox " + id).disabled = true;
        QuienRecibe = "@User.Identity.Name"
        $.ajax({
            type: "POST",
            url: "/archivo/recibido",
            traditional: true,
            data: {
                id, QuienRecibe,
            },
            error: function (response) {
                alert("Hubo un error, no se pudieron guardar los datos, contacte con el administrador del sistema");
                Console.Message(response);
            }
        });
    }

    function revisado(id) {
        QuienRevisa = "@User.Identity.Name"
        $.ajax({
            type: "POST",
            url: "/Archivo/revisado",
            traditional: true,
            data: {
                id, QuienRevisa,
            },
            error: function (response) {
                alert("Hubo un error, no se pudieron guardar los datos, contacte con el administrador del sistema");
                Console.Message(response);
            }
        });
    }
    function actualizarIdArchivo(id) {
        var idarchivo = document.getElementById("idarchivo_" + id).value;
        $.ajax({
            type: "POST",
            url: "/Archivo/ActualizarIdArchivo",
            data: {
                id: id,
                idarchivo: idarchivo
            },
            success: function () {
                console.log("Idarchivo actualizado");
            },
            error: function () {
                alert("Error al actualizar idarchivo");
            }
        });
    }
    function actualizarObservaciones(id) {
        var observaciones = document.getElementById("observaciones_" + id).value;
        $.ajax({
            type: "POST",
            url: "/Archivo/ActualizarObservaciones",
            data: {
                id: id,
                observaciones: observaciones
            },
            success: function () {
                console.log("Observaciones actualizadas");
            },
            error: function () {
                alert("Error al actualizar observaciones");
            }
        });
    }


    function createEnvioArchivo() {
        //PRIMERO SOLICITAMOS LOS DATOS  PARA BUSCAR A LA PERSONA ADULTA
        Swal.fire({
            title: "Buscar persona",
            html: `
                <div>
                    <label class="control-label">Area: @ViewBag.AreaAsignada</label>
                    <br/>
                    <label class="control-label">Coloque el Id</label>
                    <input required id="Id" type="text" class="form-control"/>
                    <br />
                    <a href="/Archivo/CreateEnvioArchivo">O Registre Manualmente</a>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: "Buscar",
            cancelButtonText: "Cancelar",
            cancelButtonColor: "#d33",
            focusConfirm: false,
            preConfirm: () => {
                //AQUI SE ACCEDE ANTES DE CONTINUAR CON LA FUNCION AJAX
                area = '@ViewBag.AreaAsignada';
                let areaFinal = (area === "Servicios previos") ? "ServiciosPrevios" :(area === "MCySCP") ? "MCYSCP" : (area === "LC") ? "LibertadCondicionada": (area === "Ejecución de Penas") ? "Ejecucion": area;
                let AreaSinEspacios = area.replace(/\s+/g, "");
                var Id = document.getElementById('Id').value;
                        
                //SI NO ESTAN COMPLETOS SE RETORNA LA FUNCION SOLICITANDO QUE LOS LLENEN
                if (!Id || !areaFinal) {
                    Swal.showValidationMessage('Llena los campos para continuar!');
                    return false;
                }
                //ANIMACION DE BUSCANDO
                Swal.showValidationMessage(`
                    <div style="display:flex;align-items:center;gap:8px;justify-content:center;">
                        <div class="swal2-loader"></div> Buscando...
                    </div>
                `);
                // SI TODO ES CORRECTO LLEGA AQUI PARA BUSCAR

                if (area != "MCySCP" && area != "LC")
                {
                    //METODO DIFERENTE PARA TRAER DATOS DE OTRAS AREAS QUE NO SEAN MCSCP Y LIBERTAD
                    buscarDatosOtrasAreas(Id,areaFinal);
                }
                else{
                    //SE OPTO POR USAR UN METODO DIFERENTE PARA LAS AREAS DE MC Y SCP O LIBERTAD CONDICIONADA
                    //POR QUE METODO SACAR DATOS EN API NO TRAE LOS DATOS NECESARIOS PARA ESTAS AREAS
                    buscarDatosMCYLC(Id,areaFinal);
                }
            }
        });
    }

    function buscarDatosOtrasAreas(Id,areaFinal){
        return $.ajax({
            url: '/Api/Sacardatos',
            type: 'GET',
            data: { Id: Id, tabla: areaFinal },
            success: function(response) {
                // SI HAY UN ERROR EN EL CONTROLADOR
                if (response.error) {
                    Swal.fire('Error', response.message, 'error');
                    return;
                }
                //SI LA LISTA ESTA VACIA RETORNA UN MENSAJE DE PERSONA NO ENCONTRADA
                if(response.lista.length == 0){
                    Swal.fire({
                      title: 'Error',
                      text: 'Persona no encontrada',
                      icon: 'error',
                      timer: 1200, // 1.2 SEGUNDOS PARA QUE SE CIERRE SOLO
                      showConfirmButton: true
                    });
                    return;
                }
                //SI NO HAY ERRORES SE CONTINUA CON UN MENSAJE DE EXITO
                personaEncontrada();
                //SE VA A LA FUNCION DE ABAJO PARA CONTINUAR CON EL LLENADO AUTOMATICO DEL FORMULARIO
                llenarElementosFormulario(response.lista);

            },
            error: function(message) {
                Swal.showValidationMessage(`Request failed: ${message.statusText}`);
            }
        });
    }

    //PARA LLENAR DATOS DE MC Y SCP Y LIBERTAD
    function buscarDatosMCYLC(Id,areaFinal){
        //SE OPTO POR USAR UN METODO DIFERENTE PARA LAS AREAS DE MC Y SCP O LIBERTAD CONDICIONADA
        //POR QUE METODO SACAR DATOS EN API NO TRAE LOS DATOS NECESARIOS PARA ESTAS AREAS
            return $.ajax({
            url: '/Api/SupervisionCompletaMCLC',
            type: 'GET',
            data: { idPersona: Id, area: areaFinal },
            success: function(response) {
                // SI HAY UN ERROR EN EL CONTROLADOR
                if (!response.success) {
                    Swal.fire('Error', response.message, 'error');
                    return;
                }
                //SI LA LISTA ESTA VACIA RETORNA UN MENSAJE DE PERSONA NO ENCONTRADA
                if(response.lista.length == 0){
                    Swal.fire({
                      title: 'Error',
                      text: 'Persona no encontrada',
                      icon: 'error',
                      timer: 1200, // 1.2 SEGUNDOS PARA QUE SE CIERRE SOLO
                      showConfirmButton: true
                    });
                    return;
                }

                if(response.lista.length > 1){
                    //SI LA PERSONA TIENE MAS DE UNA SUPERVISION
                    //FUNCION PARA QUE EL USUARIO SELECCION CUAL SUPERVISION QUIERE UTILIZAR
                    seleccionarSupervision(response.lista);
                    return;
                }
                else{
                    //LA PERSONA SOLO TIENE UNA SUPERVISION SE VA DIRECTO A LLENAR LOS DATOS
                    personaEncontrada();
                    llenarElementosFormulario(response.lista);
                    return;
                }

            },
            error: function(message) {
                Swal.showValidationMessage(`Request failed: ${message.statusText}`);
            }
        });
    }

    function personaEncontrada(){
        Swal.fire({
          title: 'Éxito',
          text: 'Persona encontrada',
          icon: 'success',
          timer: 800, // DURA 0.8 SEGUNDOS
          showConfirmButton: false
        });
    }

    function seleccionarSupervision(lista) {
        if (!lista || lista.length === 0) {
            Swal.fire({
                icon: "error",
                title: "Sin supervisiones",
                text: "No hay supervisiones disponibles para esta persona."
            });
            return;
        }

        let options = "";
        //PRIMERO LLENAMOS UNA VARIABLE CON LAS SUPERVISIONES
         area = '@ViewBag.AreaAsignada';
         let areaFinal =  (area === "MCySCP") ? "MCYSCP" : (area === "LC") ? "Libertad Condicionada": (area === "Ejecución de Penas") ? "Ejecucion": area;
        const persona = lista[0].persona;
        const nombrePersona = `${persona.nombre}  ${persona.materno} ${persona.paterno}`;
        if(areaFinal == "MCYSCP"){
            lista.forEach((item, index) => {
                const supervision = item.supervision;
                const fracciones = item.fracciones;

                options += `<option value="${supervision.idSupervision}">
                                IdSuper ${supervision.idSupervision}
                                -Estado: ${supervision.estadoSupervision}
                                - Figura: ${fracciones?.figuraJudicial || "Sin figura"}
                                - CP: ${item.causaPenal?.causaPenal || ""}
                            </option>`;
            });
        }
        else if (areaFinal == "Libertad Condicionada"){
            lista.forEach((item, index) => {
                const supervision = item.supervision;
                const fracciones = item.fracciones;

                options += `<option value="${supervision.idSupervisioncl}">
                                IdSuper ${supervision.idSupervisioncl}
                                -Estado: ${supervision.estadoSupervision}
                                - Figura: ${fracciones?.figuraJudicial || "Sin figura"}
                                - CP: ${item.causaPenal?.causaPenal || ""}
                            </option>`;
            });
        }


        //DESPUES DE QUE SE LLENA LAS MOSTRAMOS CON LA OPCION HTML DE ABAJO
        Swal.fire({
            title: "Selecciona una supervisión de " + nombrePersona,
            html: `
                <select id="supervisionSelect" class="swal2-select">
                    ${options}
                </select>
            `,
            showCancelButton: true,
            confirmButtonText: "Seleccionar",
            cancelButtonText: "Cancelar",
            preConfirm: () => {
                //CUANDO EL USUARIO ESCOGE UNA Y LE DA A SELECCIONAR LLEGA AQUI
                const selectedId = document.getElementById("supervisionSelect").value;

                if (!selectedId) {
                    Swal.showValidationMessage("Debes seleccionar una supervisión");
                    return false;
                }
                return selectedId;//DESPUES VA A RETORNAR EL ID SUPERVISION SELECCIONADO
            }
        }).then((result) => {
             if (result.isConfirmed) {
                const idSupervision = result.value;
                let itemSeleccionado;
                //AQUI SE SELECCIONAN TODOS LOS DATOS DE LA SUPERVISION, INCLUYE PERSONA, CAUSA PENAL, SUPERVISION Y FRACCIONES
                if(areaFinal == "MCYSCP"){
                    itemSeleccionado = lista.filter(item => item.supervision.idSupervision == idSupervision)
                }
                else if (areaFinal == "Libertad Condicionada"){
                    itemSeleccionado = lista.filter(item => item.supervision.idSupervisioncl == idSupervision);
                }
                Swal.fire({
                    icon: "success",
                    title: "Supervisión seleccionada",
                    text: `Elegiste la supervisión con ID: ${idSupervision}`,
                    timer: 1000,
                    showConfirmButton: false
                });
                //DESPUES DE MOSTRAR LA ALERTA DE SELECCIONADO MANDAMOS LOS ELEMENTO DEL ID SUPERVISION SELECCIONADO AL LLENADO AUTOMATICO DEL FORMULARIO
                llenarElementosFormulario(itemSeleccionado);

            }
        });
    }

    function llenarElementosFormulario(lista){
    let inputNombre ="";
    let inputApaterno ="";
    let inputAmaterno ="";
    let selectGenero ="";
    let inputCausaPenal ="";
    let inputDelito ="";
    let inputEstadoSupervision ="";
    area = '@ViewBag.AreaAsignada';
    let areaFinal = (area === "Servicios previos") ? "Servicios Previos" : (area === "MCySCP") ? "MCYSCP" : (area === "LC") ? "Libertad Condicionada": (area === "Ejecución de Penas") ? "Ejecucion": area;
    switch(areaFinal) {
        case "Ejecucion":
            const item1 = lista[0];
            inputNombre = item1.p?.nombre || "NA";
            inputApaterno = item1.p?.paterno || "NA";
            inputAmaterno = item1.p?.materno || "NA";
            selectGenero = "";
            inputCausaPenal = item1.p?.ce || "NA";
            inputDelito = "";
            inputEstadoSupervision = item1.p?.estadoActual|| "NA";
            break;

        case "MCYSCP":
        case "Libertad Condicionada":
            const item2 = lista[0];
                inputNombre = item2.persona?.nombre || "NA";
                inputApaterno = item2.persona?.paterno || "NA";
                inputAmaterno = item2.persona?.materno || "NA";
                selectGenero = item2.persona?.genero || "";
                inputCausaPenal = (item2.causaPenal && item2.causaPenal.causaPenal) ? item2.causaPenal.causaPenal : "NA";
                inputDelito = (item2.delito && item2.delito.tipo) ? item2.delito.tipo : "NA";
                inputEstadoSupervision = item2.supervision?.estadoSupervision|| "NA";
            break;
        case "Servicios Previos":
            const item3 = lista[0];
            inputNombre = item3.p?.nombre || "NA";
            inputApaterno = item3.p?.paterno || "NA";
            inputAmaterno = item3.p?.materno || "NA";
            selectGenero = "";
            inputCausaPenal = "NA";
            inputDelito = item3.p?.delito || "NA";
            inputEstadoSupervision = item3.p?.situacion|| "NA";
            break;
        case "Oficialia":
            const item4 = lista[0];
            inputNombre = item4.p?.nombre || "NA";
            inputApaterno = item4.p?.paterno || "NA";
            inputAmaterno = item4.p?.materno || "NA";
            selectGenero = "";
            inputFiguraJudicial = "NA";
            inputAutoridad = item4.p?.juzgado || "NA";
            break;
        default:
    }

        // Detectar campos faltantes (se consideran faltantes si son vacíos, null o "NA")
        const missing = [];
        if (!inputNombre || inputNombre === "NA") missing.push("Nombre");
        if (!inputApaterno || inputApaterno === "NA") missing.push("Apellido paterno");
        if (!inputAmaterno || inputAmaterno === "NA") missing.push("Apellido materno");
        if (!inputCausaPenal || inputCausaPenal === "NA") missing.push("Causa penal / Carpeta de ejecución");
        if (!inputDelito || inputDelito === "NA" || inputDelito.trim() === "") missing.push("Delito");
        if (!inputEstadoSupervision || inputEstadoSupervision === "NA") missing.push("Situación jurídico / Estado de supervisión");

        // Construir aviso dinámico si hay campos faltantes
        let avisoCampos = "";
        if (missing.length > 0) {
            const listaHtml = missing.map(f => `<li>${f}</li>`).join("");
            avisoCampos = `
                <div class="alert alert-warning" role="alert" style="text-align:left;">
                    <strong>Atención:</strong> No se encontraron los siguientes datos:
                    <ul style="margin-bottom:0;">
                        ${listaHtml}
                    </ul>
                    Se recomienda completar estos campos antes de enviar.
            </div>
        `;
    }

    Swal.fire({
        title: 'Registrar Envío de Archivo',
        width: '60%',
        html: `
                ${avisoCampos}
            <form id="formEnvioArchivo" asp-action="createEnvioArchivo">
                <div class="form-group">
                    <label>Apellido Paterno</label>
                    <input name="Apaterno" value="${inputApaterno}" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Apellido Materno</label>
                    <input name="Amaterno" value="${inputAmaterno}" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Nombre</label>
                    <input name="Nombre" value="${inputNombre}" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Causa penal/Carpeta de Ejecución</label>
                        <input name="Causapenal" id="Causapenal" value="${inputCausaPenal}" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Delito</label>
                    <input name="Delito" id="Delito" value="${inputDelito}" class="form-control" />
                </div>
                    <div class="form-group">
                        <label>Situación Jurídico</label>
                        <input name="SituacionJuridico" id="SituacionJuridico" value="${inputEstadoSupervision}" class="form-control" />
                    </div>
                    <input type="hidden" name="Recibido" value="0"/>
                    <input type="hidden" name="Revisado" value="0"/>
                    <input type="hidden" name="IdArchvo"/>
                    <input type="hidden" name="Observaciones"/>
                    <input type="hidden" name="Area" value="@ViewBag.AreaAsignada"/>
                    <input type="hidden" name="Usuario" value="@User.Identity.Name"/>
                    <input type="hidden" name="FechaRegistro" value="@DateTime.Now"/>
            </form>
        `,
        showCancelButton: true,
        confirmButtonText: 'Enviar',
        confirmButtonColor: '#02bd05',
        cancelButtonText: 'Cancelar',
        cancelButtonColor: "#d33",
        preConfirm: () => {
                // Revalidar al enviar (por si el usuario modificó campos en el modal)
                const causa = document.getElementById("Causapenal")?.value || "";
                const delito = document.getElementById("Delito")?.value || "";
                const faltantes = [];
                if (!causa || causa.trim() === "" || causa === "NA") faltantes.push("Causa penal / Carpeta de ejecución");
                if (!delito || delito.trim() === "" || delito === "NA") faltantes.push("Delito");

                if (faltantes.length > 0) {
                    // Si quieres impedir envío descomenta next line y devuelve false
                    // Swal.showValidationMessage(`Faltan campos: ${faltantes.join(", ")}`);
                    // return false;

                    // Mostrar confirmación extra si faltan campos
                    return Swal.fire({
                        title: 'Faltan datos importantes',
                        html: `Los siguientes campos están vacíos:<br><strong>${faltantes.join(", ")}</strong><br>¿Deseas continuar de todos modos?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Continuar',
                        cancelButtonText: 'Cancelar'
                    }).then(res => {
                        if (res.isConfirmed) {
                            // continuar con el envío
                            const form = document.getElementById("formEnvioArchivo");
                            const formData = new FormData(form);
                            return fetch("/Archivo/NuevoCreateEnvioArchivo", { method: 'POST', body: formData })
                                .then(response => {
                                    if (!response.ok) throw new Error(response.statusText);
                                    return response.json();
                                })
                                .catch(error => { Swal.showValidationMessage(`Error: ${error}`); });
                        } else {
                            // cancelar el envío (preConfirm fallará)
                            Swal.showValidationMessage('Envio cancelado. Completa los campos y vuelve a intentar.');
                            return false;
                        }
                    });
                }

                // Si no faltan campos, enviar directamente
                const form = document.getElementById("formEnvioArchivo");
                const formData = new FormData(form);
                return fetch("/Archivo/NuevoCreateEnvioArchivo", { method: 'POST', body: formData })
                    .then(response => {
                        if (!response.ok) throw new Error(response.statusText);
                        return response.json();
                    })
                    .catch(error => { Swal.showValidationMessage(`Error: ${error}`); });
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire('Éxito', 'Formulario enviado correctamente', 'success');
            location.reload();
        }
    });
}
    
</script>


<h2>Envio Archivo</h2>
@*
<p>
    <a asp-action="Create"></a>
</p>
*@

<form asp-action="Envioarchivo" method="get" class="mb-4">
    <div class="row g-3 align-items-end">
        <!-- Búsqueda por nombre o Id -->
        <div class="col-md-2">
            <label for="SearchString" class="form-label">Nombre o IdArchivo</label>
            <input type="text" id="SearchString" name="SearchString" class="form-control" placeholder="Buscar..." value="@ViewData["currentFilter"]" />
        </div>

        <!-- Filtro Área -->
        <div class="col-md-2">
            <label>
                Area
            </label>
            <select class="form-control" name="areaFiltro" id="areaFiltro"
                    asp-items="@(new SelectList(ViewBag.ListaAreas, "Text", "Text", @ViewData["areaFiltro"]))">
            </select>
        </div>

        <!-- Filtro Recibido -->
        <div class="col-md-2">
            <label>
                Recibido
            </label>
            <select class="form-control" name="recibidoFiltro" id="recibidoFiltro"
                    asp-items="@(new SelectList(ViewBag.listaFiltro1, "Text", "Text", @ViewData["recibidoFiltro"]))">
            </select>
        </div>

        <!-- Filtro Revisado -->
        <div class="col-md-2">
            <label>
                Revisado
            </label>
            <select class="form-control" name="revisadoFiltro" id="revisadoFiltro"
                    asp-items="@(new SelectList(ViewBag.listaFiltro2, "Text", "Text", @ViewData["revisadoFiltro"]))">
            </select>
        </div>

        <!-- Filtro Fecha Desde -->
        <div class="col-md-2">
            <label for="fechaDesde" class="form-label">Fecha Desde</label>
            <input type="date" id="fechaDesde" name="fechaDesde" class="form-control" value="@ViewBag.fInicio" />
        </div>

        <!-- Filtro Fecha Hasta -->
        <div class="col-md-2">
            <label for="fechaHasta" class="form-label">Fecha Hasta</label>
            <input type="date" id="fechaHasta" name="fechaHasta" class="form-control" value="@ViewBag.fFinal" />
        </div>

        <!-- Botón Buscar -->
        <div class="col-md-2" style="margin-top:20px;">
            <button type="submit" class="btn btn-primary">
                <i class="fa fa-search me-1"></i> Buscar
            </button>
        </div>
    </div>
</form>
<hr size="2px" color="black" />
<div style="text-align:left" class="col-md-6">
    <a asp-action="Envioarchivo">Regresar al Listado Completo </a>
</div>
<div style="text-align:right" class="col-md-6">
    @if (User.IsInRole("Oficialia") || User.IsInRole("Uespa") || User.IsInRole("Servicios previos"))
    {
        <a asp-action="createEnvioArchivo" class="button-27 carnet" id="createEnvioArchivo" title="Envio Archivo">
            <i class=" btn btn-primary fa fa-book float-right">&nbsp;Crear nuevo Registro</i>
        </a>
    }else{
@*         <a asp-action="createEnvioArchivo" class="button-27 carnet" id="createEnvioArchivo" title="Envio Archivo">
            <i class=" btn btn-primary fa fa-book float-right">&nbsp;Crear nuevo Registro</i>
        </a> *@
         <a onclick="createEnvioArchivo();" class="button-27 carnet" id="createEnvioArchivo" title="Envio Archivo">
            <i class=" btn btn-primary fa fa-book float-right">&nbsp;Crear nuevo Registro</i>
        </a>  
    }
    
</div>

<table class="table">
    <thead>
        <tr>
                <th>
                    Fecha de Recibido
                </th>
                <th>
                    Area
                </th>
                <th>
                    Nombre completo
                </th>
                <th>
                    Causa Penal
                </th>
                <th>
                    Delito
                </th>
                <th>
                    Tipo de Documento
                </th>
                <th>
                    Situacion Juridico
                </th>
                @if (User.IsInRole("Coordinador"))
                {
                    <td>
                        Quien Recibe
                    </td> 
                    <td>
                        Fecha Recibido
                    </td>
                    <td>
                        Quien Revisa
                    </td>
                    <td>
                        Fecha Revisado
                    </td>
                }
                 @if (User.IsInRole("ArchivoAsistente") || User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                    <th>
                        Revisado
                    </th>
                    <th>
                        Id de Archvo
                    </th>
                    <th>
                        Observaciones
                    </th>
                }
                 @if (User.IsInRole("EnvioArchivo") || User.IsInRole("Masteradmin"))
                {
                    <th>
                        Editar
                    </th>
                }

           
            <th></th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.FechaRecibido)
            </td> 
            <td>
                @Html.DisplayFor(modelItem => item.Area)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Nombre) @Html.DisplayFor(modelItem => item.Apaterno) @Html.DisplayFor(modelItem => item.Amaterno)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Causapenal)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Delito)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.TipoDocumento)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.SituacionJuridico)
            </td>
            @if (User.IsInRole("Coordinador"))
            {
                <td>
                    @Html.DisplayFor(modelItem => item.QuienRecibe)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.FechaRecibido)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.QuienRevisa)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.FechaRevisado)
                </td>
            }
            <td>
                @if (User.IsInRole("ArchivoAsistente") || User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                if(item.Recibido == 0)
                {
                    <input class="form-check-input" type="checkbox" id="myCheckbox @item.IdenvioArchivo" onchange="recibido(@item.IdenvioArchivo)" @(item.Recibido == 1 ? "checked" : "") />
                }else{
                    <input class="form-check-input" type="checkbox" disabled id="myCheckbox @item.IdenvioArchivo " onchange="recibido(@item.IdenvioArchivo)" @(item.Recibido == 1 ? "checked" : "") />
                }
                }else{
                    <input disabled class="form-check-input" type="checkbox" id="myCheckbox @item.IdenvioArchivo" onchange="recibido(@item.IdenvioArchivo)" @(item.Recibido == 1 ? "checked" : "") />
                }
                  
            </td>
            <td>
                 @if (User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                        <input class="form-check-input" type="checkbox" onchange="revisado(@item.IdenvioArchivo)" @(item.Revisado == 1 ? "checked" : "") />
                }
                else if (User.IsInRole("ArchivoAsistente"))
                {
                    <input disabled class="form-check-input" type="checkbox" onchange="revisado(@item.IdenvioArchivo)" @(item.Revisado == 1 ? "checked " : "") />

                }else
                {
                    <input style="display:none" disabled class="form-check-input" type="checkbox" onchange="revisado(@item.IdenvioArchivo)" @(item.Revisado == 1 ? "checked " : "") />
                }
                    
            </td>
            <td>
                @if (User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                    <input type="text" class="form-control" id="idarchivo_@item.IdenvioArchivo" value="@item.IdArchvo" onblur="actualizarIdArchivo(@item.IdenvioArchivo)" style="width: 100px;" />

                }
                else if (User.IsInRole("ArchivoAsistente"))
                {
                    <input disabled type="text" class="form-control" id="idarchivo_@item.IdenvioArchivo" value="@item.IdArchvo" onblur="actualizarIdArchivo(@item.IdenvioArchivo)" />
                }else
                {
                    <input style="display:none" disabled type="text" class="form-control" id="idarchivo_@item.IdenvioArchivo" value="@item.IdArchvo" onblur="actualizarIdArchivo(@item.IdenvioArchivo)" />    
                }   
            </td>

            <td>
                @if (User.IsInRole("Archivo") || User.IsInRole("Masteradmin"))
                {
                    <input type="text" class="form-control" id="observaciones_@item.IdenvioArchivo" value="@item.Observaciones" style="min-width: 300px;" onblur="actualizarObservaciones(@item.IdenvioArchivo)" />
                }
                else if (User.IsInRole("ArchivoAsistente"))
                {
                    <input disabled type="text" class="form-control" id="observaciones_@item.IdenvioArchivo" value="@item.Observaciones" style="min-width: 300px;" onblur="actualizarObservaciones(@item.IdenvioArchivo)" />
                }else
                {
                    <input style="display:none" disabled type="text" class="form-control" id="observaciones_@item.IdenvioArchivo" value="@item.Observaciones" style="min-width: 300px;" onblur="actualizarObservaciones(@item.IdenvioArchivo)" />
                }
                    
            </td>
            @if (User.IsInRole("EnvioArchivo") || User.IsInRole("Masteradmin"))
            {
                <td>
                    <a id="btnEditar" onclick="modal(@item.IdenvioArchivo, @item.Recibido)" class="btn btn-success">
                        <i class="fa fa-pencil"></i> Editar
                    </a>

                    @*<a id="btnEditar" onclick="showModal('@Url.Action("editEnvioArchivo","Archivo",null,Context.Request.Scheme)','Editar Registro', @item.IdenvioArchivo)" class="btn btn-success">*@

                </td> 
                <td>
                    <a id="btnBorrar" onclick="borrarEnvioA(@item.IdenvioArchivo, @item.Recibido)" class="btn btn-danger">
                        <i class="fa fa-trash"></i> Borrar
                    </a>
                </td>
            }
        </tr>
    }
    </tbody>
</table>

@{
    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
}

<p>
    Página @(Model.TotalPages < Model.PageIndex ? 0 : Model.PageIndex) de @Model.TotalPages
</p>
<a asp-action="Envioarchivo"
   asp-route-sortOrder="@ViewData["CurrentSort"]"
   asp-route-pageNumber="@(Model.PageIndex - 1)"
   asp-route-currentFilter="@ViewData["CurrentFilter"]"
   asp-route-areaFiltro="@ViewData["areaFiltro"]"
   asp-route-recibidoFiltro="@ViewData["recibidoFiltro"]"
   asp-route-revisadoFiltro="@ViewData["revisadoFiltro"]"
   asp-route-fechaInicio="@ViewData["fInicio"]"
   asp-route-fechaFinal="@ViewData["fFinal"]"
   class="btn btn-default @prevDisabled">
    Anterior
</a>
<a asp-action="Envioarchivo"
   asp-route-sortOrder="@ViewData["CurrentSort"]"
   asp-route-pageNumber="@(Model.PageIndex + 1)"
   asp-route-currentFilter="@ViewData["CurrentFilter"]"
   asp-route-areaFiltro="@ViewData["areaFiltro"]"
   asp-route-recibidoFiltro="@ViewData["recibidoFiltro"]"
   asp-route-revisadoFiltro="@ViewData["revisadoFiltro"]"
   asp-route-fechaDesde="@ViewBag.fInicio"
   asp-route-fechaHasta="@ViewBag.fFinal"
   class="btn btn-default @nextDisabled">
    Siguiente
</a>